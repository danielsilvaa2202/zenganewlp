<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Clientes | Visual Moderno</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet-curve@0.9.1/leaflet.curve.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GERAL DA PÁGINA --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1d2b3a, #101820);
            color: #f0f0f0;
            overflow: hidden; /* Evita barras de rolagem */
        }

        /* --- TÍTULO --- */
        #title-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001; /* Garante que fique sobre o mapa */
            background-color: rgba(26, 38, 51, 0.85);
            padding: 10px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- MAPA --- */
        #map {
            height: 100vh;
            width: 100vw;
            background-color: #101820; /* Cor de fundo enquanto o mapa carrega */
        }

        /* --- POP-UP (JANELA DE INFORMAÇÃO) ESTILIZADA --- */
        .leaflet-popup-content-wrapper {
            background-color: #2a3a4a; /* Fundo do pop-up */
            color: #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .leaflet-popup-content b {
            font-weight: 600;
            color: #58b0f8; /* Cor de destaque para o nome da empresa */
        }
        
        .leaflet-popup-tip {
            background-color: #2a3a4a;
        }

        .leaflet-popup-close-button {
            color: #f0f0f0 !important; /* Força a cor do 'X' para fechar */
        }

        /* --- MARCADORES PULSANTES --- */
        @keyframes pulse {
            0% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 12px rgba(23, 162, 184, 0);
            }
            100% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(23, 162, 184, 0);
            }
        }

        .pulsing-marker {
            background-color: #17a2b8;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            box-shadow: 0 0 0 rgba(23, 162, 184, 0.7);
            animation: pulse 2s infinite;
        }
        
        /* --- LINHAS CURVAS ANIMADAS --- */
        .animated-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-line 5s ease-in-out forwards;
        }

        @keyframes draw-line {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>
</head>
<body>

    <div id="title-container">
        <h1>Dashboard de Clientes</h1>
    </div>

    <div id="map"></div>

    <script>
        // --- 1. INICIALIZAÇÃO DO MAPA ---
        const map = L.map('map', {
            zoomControl: false // Desativar controle de zoom padrão
        }).setView([-14.2350, -51.9253], 5); // Centralizado no Brasil com mais zoom

        // Adicionar controle de zoom na posição inferior direita
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // --- 2. ADICIONAR TEMA DO MAPA (TILE LAYER) ---
        // Tema escuro moderno da CARTO
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // --- 3. DADOS DOS CLIENTES ---
        // (Adicionei uma pequena variação aleatória nas coordenadas para evitar sobreposição exata)
        const clients = [
            { "ID": 1, "NOME": "MATRIZ CONTABILIDADE LTDA", "UF": "PE", "CNPJ": "261445000103", "COMPETENCIA_INICIAL": 20250521, "coords": [-8.0476 + (Math.random() - 0.5) * 0.1, -34.8770 + (Math.random() - 0.5) * 0.1] },
            { "ID": 2, "NOME": "ALEXANDRE CALDERON E ASSOCIADOS S/S", "UF": "SP", "CNPJ": "2657812000161", "COMPETENCIA_INICIAL": 20250506, "coords": [-23.5505 + (Math.random() - 0.5) * 0.1, -46.6333 + (Math.random() - 0.5) * 0.1] },
            { "ID": 3, "NOME": "CJR CONTABILIDADE, CONSULTORIA, AUDITORIA E PERICIA LTDA", "UF": "MG", "CNPJ": "444099000153", "COMPETENCIA_INICIAL": 20250522, "coords": [-19.9167 + (Math.random() - 0.5) * 0.1, -43.9345 + (Math.random() - 0.5) * 0.1] },
            { "ID": 4, "NOME": "PRO JURIDICO CONTABILIDADE S/S", "UF": "SP", "CNPJ": "095776000103", "COMPETENCIA_INICIAL": 20250501, "coords": [-23.5505 + (Math.random() - 0.5) * 0.1, -46.6333 + (Math.random() - 0.5) * 0.1] },
            { "ID": 5, "NOME": "ALIANCA CONTABIL AMAZONAS", "UF": "AM", "CNPJ": "054960000150", "COMPETENCIA_INICIAL": 20250511, "coords": [-3.1190 + (Math.random() - 0.5) * 0.1, -60.0217 + (Math.random() - 0.5) * 0.1] },
            { "ID": 8, "NOME": "RM SILVA CONTABILIDADE", "UF": "MT", "CNPJ": "707494000198", "COMPETENCIA_INICIAL": 20250807, "coords": [-15.6014 + (Math.random() - 0.5) * 0.1, -56.0979 + (Math.random() - 0.5) * 0.1] },
            { "ID": 17, "NOME": "GARBIN GESTAO E ASSESSORIA CONTABIL LTDA", "UF": "PR", "CNPJ": "8870478000191", "COMPETENCIA_INICIAL": 20250928, "coords": [-25.2521 + (Math.random() - 0.5) * 0.1, -52.0215 + (Math.random() - 0.5) * 0.1] },
            { "ID": 21, "NOME": "ESTILO CONTABILIDADE SS LTDA", "UF": "PR", "CNPJ": "2208507000146", "COMPETENCIA_INICIAL": 20250907, "coords": [-25.2521 + (Math.random() - 0.5) * 0.1, -52.0215 + (Math.random() - 0.5) * 0.1] },
        ];

        // --- 4. ADICIONAR MARCADORES E POP-UPS ---
        clients.forEach(client => {
            const customMarker = L.divIcon({
                className: 'pulsing-marker',
                iconSize: [15, 15]
            });

            const marker = L.marker(client.coords, { icon: customMarker }).addTo(map);
            
            const popupContent = `
                <b>${client.NOME}</b><br>
                <strong>CNPJ:</strong> ${client.CNPJ}<br>
                <strong>UF:</strong> ${client.UF}
            `;
            
            marker.bindPopup(popupContent);
        });

        // --- 5. ADICIONAR LINHAS CURVAS ANIMADAS ---
        const locations = {
            sp: [-23.5505, -46.6333],
            pe: [-8.0476, -34.8770],
            am: [-3.1190, -60.0217],
            mg: [-19.9167, -43.9345],
            pr: [-25.2521, -52.0215],
            mt: [-15.6014, -56.0979]
        };

        const connections = [
            { from: locations.sp, to: locations.am, control: [-10, -55], color: '#3498db', delay: '0s' }, // SP -> AM (Azul)
            { from: locations.sp, to: locations.pe, control: [-15, -35], color: '#e74c3c', delay: '0.5s' }, // SP -> PE (Vermelho)
            { from: locations.mg, to: locations.pr, control: [-22, -48], color: '#2ecc71', delay: '1s' }, // MG -> PR (Verde)
            { from: locations.pr, to: locations.mt, control: [-20, -54], color: '#9b59b6', delay: '1.5s' }  // PR -> MT (Roxo)
        ];

        connections.forEach(conn => {
            const curve = L.curve(
                ['M', conn.from, 'Q', conn.control, conn.to],
                {
                    color: conn.color,
                    weight: 3,
                    opacity: 0.8,
                    className: 'animated-path' // Aplica a classe para animação
                }
            ).addTo(map);
            
            // Aplica o delay na animação via JavaScript
            curve._path.style.animationDelay = conn.delay;
        });

    </script>

</body>
</html>